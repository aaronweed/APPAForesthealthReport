---
title: "Forest bird summary at Morristown National Historical Park"
author: "*NETN `r Sys.time()`*"
output: 
  html_document:
    highlight: textmate
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
  version: Built with R `r getRversion()`
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# load in packages
library(magrittr)
library(devtools)
library(tidyverse)
library(NCRNbirds)
library(leaflet)
library(cowplot)
library(readxl)

Park<-"MORR"
year <- 2019
points<-NA

# load in data
NETN = importNETNbirds("~/R/Mulit-network/NCRNbirds/Data/NETN")
tlu_GuildRatings <- read_excel("~/R/NETN/Landbirds/NETN_Landbirds/Look up tables/tlu_GuildRatings.xlsx")

# model data
#The file "spMeanTrends.csv" contains the data used to generate the trends in abundance for each species across the study years.It contains the estimated trend in species abundance after accounting for imperfect detection and effects of forest covariates. 

spMeanTrends <- read.csv("./Data/spMeanTrends.csv") %>% 
  pivot_longer(cols= 3:11, names_to = "park") %>% 
  add_column(variable = "Trend Estimate") %>% rename(Year = years, AOU_Code= species) %>% 
  dplyr::filter(park == Park)

#import in Doser et al. 2020 trend estimates per species
spMeanYearEffect <- read.csv("./Data/spMeanYearEffect.csv") %>% 
   pivot_longer(cols= 3:11, names_to = "park", values_to ="value") %>% 
  pivot_wider(id_cols=  c(park, species), names_from = "type", values_from= "value" ) %>% 
  rename(AOU_Code= species) %>% 
  dplyr::filter(park == Park)

guildsMeanTrends <-read.csv("./Data/guildsMeanTrends.csv") # guild-level annual model estimates

guild_tlu<-getGuilds(NETN) %>% filter( BCI_Type == "Cent_Appal")%>% rename(Species_Guild = AOU_Code)

pointCommunity <- read.csv("./Data/point-rich-bci-by-year.csv")
 
ParkCommAnnual <- read.csv("./Data/park-rich-bci-by-year.csv")
 
ParkList<-NCRNbirds::getParkNames(NETN, name.class="code")

# derive raw detects and add on modeled estimates
sp_detects<- SumRelAbund(NETN[ParkList == Park], band = 1:2, max= T)%>% # raw detection data created from SumRelAbund
  add_column(variable = "Field Observation") %>% select(park= Admin_Unit_Code, Year,  AOU_Code, value= RelAbund, variable) %>% 
  bind_rows(spMeanTrends)


minYear<-min(getBirds(NETN[ParkList == Park])$Year)
maxYear<-max(getBirds(NETN[ParkList == Park])$Year)

```

# Species Richness
## Over time across the park

```{r richness, echo = TRUE, echo=FALSE, fig.height=6, fig.width= 10, fig.align = 'center'}

plotdata<- dplyr::filter(ParkCommAnnual, park == Park) %>% select(Year= year, `Estimated Richness` = median.rich, low = low.95.rich, hi = high.95.rich) %>% 
  left_join(., NCRNbirds::birdRichness(NETN[ParkList == Park], band= 1:2, byYear = TRUE), by = "Year") %>% rename(`Observed Richness` = Richness) 

colors<- c("Field Observation" = "#2171b5","Estimated (95% C.I.)"= "dark green")
 
GraphOut<-ggplot(data=plotdata, aes(x = Year))+expand_limits(y=0)+
      geom_ribbon(data= plotdata, aes(ymin= low, ymax= hi), fill= "grey95", outline.type = "both")+
      geom_point(aes(y= `Estimated Richness`, color = "Estimated (95% C.I.)"),  size=2)+geom_line(aes(y= `Estimated Richness`, color = "Estimated (95% C.I.)"))+
      geom_point(aes(y= `Observed Richness`, color= "Field Observation"), size=2) + geom_line(aes(y= `Observed Richness`, color= "Field Observation"))+
      theme_classic()+  
      theme(axis.title.y =element_text(size = 14, face ="bold", vjust= 1))+
      theme(axis.title.x =element_text(size = 14, face ="bold", vjust= 1))+
      theme(axis.text.y = element_text(color="black", vjust= 0.5,size = 12))+
      theme(axis.text.x = element_text(color="black", size = 12))+
      scale_color_manual(values = colors)+
      scale_x_continuous(breaks = seq(2006, 2019,1))+
      labs(y=" Number of Species" ,x= "", color = "")+theme(legend.position = c(0.8,0.2))+ theme(legend.text = element_text(size = 14))

GraphOut

```

This graph shows the number of bird species observed during monitoring each year and the number of species estimated after accounting for imperfect detection (see Doser et al. 2020). Note that this is not the total number of species in the park, as other species may be present but not detected during monitoring.Data are summarized among all annual visits to a site and include all species detected.

## Species Richness across bird monitoring sites

Number of species observed during field surveys per monitoring site since `r min(birdRichness(NETN[ParkList == Park], byYear= T)$Year)`

```{r richmap, echo = FALSE,  fig.height=8, fig.width= 10, fig.align = 'center', warning= FALSE, comment=FALSE, message=FALSE}
mapRichness(NETN[ParkList == Park], title = "Number of species observed", palette = "viridis", band = 1:2)
```

\pagebreak

# Ecological Integrity -- Bird Community Index (BCI)

The Bird Community Index (O'Connell et al 2000) is designed to indicate the conservation status of the bird community in forested areas such as those in NETN parks. The BCI is calculated to indicate if the bird community has birds typical of forest habitats ("High Integrity") or has more generalist birds ("Low Integrity"). 

```{r BCI, echo=FALSE, fig.height=8, fig.width= 10, fig.align = 'center', message=FALSE}
NCRNbirds::BCIPlot(NETN[ParkList == Park], type= "Cent_Appal",  plot_title = "Average annual Bird Community Index across park", band = 1:2, caption = FALSE)
```
Data are summarized from field observations within 100 meters of the observer. The points on the graph denote the BCI rating for points monitored during 2019. The horizontal axis indicates the year, with the number of points monitored by visit in parenthesis. 

## Bird Community Index across park in `r year`

```{r map, echo = TRUE, echo=FALSE, fig.height=6, fig.width= 10, fig.align = 'center', message=FALSE}
mapBCI(NETN[ParkList == Park], band =2, type= "Cent_Appal", years = 2019)
```

Data are summarized from field observations within 100 meters of the observer. The points on the map denote the BCI rating for points monitored during `r year`.

\pagebreak

# Abundance of Top 20 most commonly detected species

Below is the mean number of birds per point in `r Park ` ordered from the most to least abundant of the 20 most commonly detected species. 
```{r top20,echo=FALSE,results='hide',fig.keep='all', cache= TRUE,  fig.height=8, fig.width= 10, fig.align = 'center', message=FALSE,warning = FALSE, comment=NA}

aou<-SumRelAbund(NETN[ParkList == Park], max=T, sort=TRUE, abund = 20, band = 1:2)$AOU_Code # get Top 20 most abundant species (birds/point)
  
spp<-getBirdNames(NETN[ParkList == Park], names= aou , out.style = "common") %>% 
    bind_cols(.,aou ) %>% tibble() %>% rename(common = 1, AOU_Code =2)
      
plotdata<-SumRelAbund(NETN[ParkList == Park], max=T, AOU = aou, band = 1:2, CalcByYear =FALSE ) %>% 
  group_by(AOU_Code) %>% 
  summarise(mean = round(mean(RelAbund,na.rm=T),2), se = sd(RelAbund)/sqrt(n()), n= n()) %>% 
  left_join(spp,., by = "AOU_Code")

BarChart<-ggplot(data= plotdata, aes(x=reorder(common,mean), y = mean)) +
geom_bar(fill="#2171b5", stat="identity",width=0.75) +
#geom_errorbar(aes(ymin= mean-se, ymax= mean +se), width = .2, color = "#2171b5")+
coord_flip()+
geom_text(aes(label = sprintf("%0.2f", round(mean, digits = 2))), hjust = -0.15, color = "black", size = 4)+
scale_y_continuous(expand = c(0,0),limits = c(0, max(plotdata$mean*1.1)))+ #set origin at 0, sets width of x axis
xlab("") +
ylab("Average number of birds detected per point per visit")+ 
theme_classic()+
theme(axis.text.y = element_text(color="black",size = 12))+
theme(axis.text.x = element_text(color="black",size = 12))+
theme(axis.title.x = element_text(color="black",size = 12, face= "bold"))

BarChart
```
Data are summarized within 100 meters from the observer and from the maximum number of birds detected among visits in a year.  The horizontal axis indicates the number of birds deteced divided by the number of points monitored.

# Trends in abundance of selected species

## Top 10 most abundant species

Below are the plotted trend estimates from Doser et al. (2020) for the top 10 most abundant species in the park. Populations in the park are stable when the trend estimate credible intervals (C.I., error bars) do not overlap 0 (e.g. Eastern Wood-Pewee). The rank order of abundance in the park is denoted in parentheses follwiing the species name. None of the most abundant species are increasing over time in the park but 6 of 10 species have stable populations. Scarlet Tanager, American Robin, Blue Jay, and Tufted Titmouse detections declined significantly during the monitoring period from `r minYear ` - `r maxYear `.  

```{r top10trend,echo=FALSE,results='hide',fig.keep='all', cache= TRUE,  fig.height=8, fig.width= 10, fig.align = 'center', message=FALSE,warning = FALSE, comment=NA}

aou<-SumRelAbund(NETN[ParkList == Park], max=T, sort=TRUE, abund = 10, band = 1:2)$AOU_Code # get Top 20 most abundant species (birds/point)
  
spp<-getBirdNames(NETN[ParkList == Park], names= aou , out.style = "common") %>% 
    bind_cols(.,aou ) %>% tibble() %>% rename(common = 1, AOU_Code =2)%>% 
    mutate(order= row_number())
      
plotdata<-filter(spMeanYearEffect, AOU_Code %in% aou) %>% 
   left_join(spp,., by = "AOU_Code") %>% 
    mutate(common = fct_reorder(common, order)) %>% 
    mutate(common = paste0(common, " (", order,")"))

BarChart<-ggplot(data= plotdata, aes(x=reorder(common,mean), y = mean)) +
geom_bar(fill="#2171b5", stat="identity",width=0.75) +
geom_errorbar(aes(ymin=lowCI, ymax= highCI), width = .2, color = "black")+
coord_flip()+ 
#geom_text(aes(label = sprintf("%0.2f", round(mean, digits = 2))), y = plotdata$mean, hjust= 1, vjust= 1,color = "black", size = 4)+
#scale_y_continuous(expand = c(0,0),limits = c(0, max(plotdata$mean*1.1)))+ #set origin at 0, sets width of x axis
xlab("") +
ylab(paste("Estimated trend over time : Birds per point per year", "\u00B1", " 95% C.I."))+ 
theme_classic()+
theme(axis.text.y = element_text(color="black",size = 12))+
theme(axis.text.x = element_text(color="black",size = 12))+
theme(axis.title.x = element_text(color="black",size = 12, face= "bold"))+
  geom_hline(yintercept= 0, col= 1)+
  theme(panel.grid.major.x = element_line(color="grey",linetype = "dashed"))+
      theme(panel.grid.major.y = element_line(color="grey", linetype = "dashed"))

BarChart
```


Below are the average counts and associated trends of the top 10 most abundant species detected since `r min(getBirds(NETN[ParkList == Park])$Year)` across the park over time showing the trend. Plots show the average annual abundance of bird observations within 100 meters of the observer among sites. During years when a site was surveyed more than once, the plotted average is calculated from the maximum count per survey visit in a year. The estimare of the trend (95% C.I.) is denoted in the upper right of each panel. If the interval does  not contain 0 the trend is statistically decreasing over time (e.g., Tufted Titmouse).

```{r Top10Trends,echo=FALSE,results='hide',fig.keep='all', fig.height=16, fig.width= 10, fig.align = 'center', message=FALSE,warning = FALSE, comment=NA}

#Get Top 10 species
aou<-SumRelAbund(NETN[ParkList == Park], max=T, sort=TRUE, abund = 10, band = 1:2)$AOU_Code

spp<-getBirdNames(NETN[ParkList == Park], names= aou , out.style = "common") %>% 
    bind_cols(.,aou ) %>% tibble() %>% rename(common = 1, AOU_Code =2) %>% 
    mutate(order= row_number())
  
#subset sp_detects    

plotdata<-filter(sp_detects, AOU_Code %in% aou) %>% 
   left_join(spp,., by = "AOU_Code") %>% 
    mutate(common = paste0(common, " (", order,")")) %>% 
    mutate(common = fct_reorder(common, order)) %>% 
  left_join(., spMeanYearEffect, by=c("AOU_Code", "park")) %>% 
  mutate(CI = )
  
GraphOut<-ggplot(data=plotdata, aes(x = Year, y = value, color = variable))+expand_limits(y=0)+
      geom_point(data= dplyr::filter(plotdata, variable == "Field Observation"),size=2) + geom_line()+
      #geom_errorbar(aes(ymin= mean-se, ymax= mean +se), width = .2, color = "#2171b5")+
      theme_classic()+
      theme(axis.title.y =element_text(size = 14, face ="bold", vjust= 1))+
      theme(axis.title.x =element_text(size = 14, face ="bold", vjust= 1))+
      theme(axis.text.y = element_text(color="black", vjust= 0.5,size = 12))+
      theme(axis.text.x = element_text(color="black", size = 10))+
      scale_x_continuous(breaks = seq(2006, 2019,2))+
      scale_color_manual(values = c("#2171b5", "dark green"))+
      labs(y="Number detected per point" , color = "")+
      theme(legend.position = "top")+ 
      theme(legend.text = element_text(size = 12))+
       theme(panel.background =  element_rect(fill="white", colour="black")) +
       theme(plot.title=element_text(size=12, vjust=2, face= "bold")) +
       theme(strip.background= element_rect(size=10, color="gray", linetype ="solid" ))+
      theme(strip.text=element_text(size=12, vjust=0, face= "bold"))+facet_wrap(~common, ncol = 2, shrink= FALSE)

GraphOut+
  geom_text(data= dplyr::filter(plotdata, variable == "Trend Estimate"), show.legend = FALSE, aes(x = Inf, y = Inf, label = paste(round(mean,2)," (",round(lowCI,2),",",round(highCI,2),")"), hjust = 1.05,vjust   = 1))

```

# References Cited

Doser, J.W., Weed, A.S., Zipkin, E.F., Miller, K.M, Finley, A.O. (2020). Trends in bird abundance differ among protected forests but not bird guilds. arXiv:1310.8192.in review at <i>Ecological Applications</i>. 

O’Connell, T. J., L. E. Jackson and R. P. Brooks. 2000. Bird guilds as indicators of ecological condition in the central Appalachians. <i>Ecological Applications</i> 10:1706-1721.