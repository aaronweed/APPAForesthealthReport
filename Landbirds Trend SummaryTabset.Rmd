---
output: 
    html_document
---
      
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# load in packages
library(magrittr)
library(devtools)
library(tidyverse)
library(NCRNbirds)
library(leaflet)
library(cowplot)
library(readxl)
library(lubridate)

network<-"NETN"
Park<-"MORR"
year <- 2019
points<-NA

# load in data
network = importNETNbirds("./Data/NETN") # needs to be fixed if multi-network
tlu_GuildRatings <- read_excel("./Data/tlu_GuildRatings.xlsx")

# model data
#The file "spMeanTrends.csv" contains the data used to generate the trends in abundance for each species across the study years.It contains the estimated trend in species abundance after accounting for imperfect detection and effects of forest covariates. 

spMeanTrends <- read.csv("./Data/spMeanTrends.csv") %>% 
  pivot_longer(cols= 3:11, names_to = "park") %>% 
  add_column(variable = "Trend Estimate") %>% rename(Year = years, AOU_Code= species) %>% 
  dplyr::filter(park == Park)

#import in Doser et al. 2020 trend estimates per species
spMeanYearEffect <- read.csv("./Data/spMeanYearEffect.csv") %>% 
   pivot_longer(cols= 3:11, names_to = "park", values_to ="value") %>% 
  pivot_wider(id_cols=  c(park, species), names_from = "type", values_from= "value" ) %>% 
  rename(AOU_Code= species) %>% 
  dplyr::filter(park == Park)

guildsMeanTrends <-read.csv("./Data/guildsMeanTrends.csv") # guild-level annual model estimates

guild_tlu<-getGuilds(network) %>% filter( BCI_Type == "Cent_Appal")%>% rename(Species_Guild = AOU_Code)

pointCommunity <- read.csv("./Data/point-rich-bci-by-year.csv")
 
ParkCommAnnual <- read.csv("./Data/park-rich-bci-by-year.csv")
 
ParkList<-NCRNbirds::getParkNames(network, name.class="code")

# derive raw detects and add on modeled estimates
sp_detects<- SumRelAbund(network[ParkList == Park], band = 1:2, max= T)%>% # raw detection data created from SumRelAbund
  add_column(variable = "Field Observation") %>% select(park= Admin_Unit_Code, Year,  AOU_Code, value= RelAbund, variable) %>% 
  bind_rows(spMeanTrends)


minYear<-min(getBirds(network[ParkList == Park])$Year)
maxYear<-max(getBirds(network[ParkList == Park])$Year)

```

Trends in Landbird monitoring at `r Park` {.tabset .tabset-fade}
------------------------------------
### Monitoring program
<div style="float:right;position:relative;top:10px;padding:5px 5px 5px 10px;margin:0px 5px 10px 5px">
```{r Effmap, echo = FALSE,  fig.height=6, fig.width= 6, fig.align = 'left', fig.caption = "Map of monitoring effort at permanent sites", warning= FALSE, comment=FALSE, message=FALSE}
mapEffort(network[ParkList == Park], palette = "viridis", title = paste0("Total surveys since ",minYear))
```
</div>
<h3> Northeast Temperate Network's Long-term Landbird monitoring Program </h3>

<p>NETN's Breeding landbird monitoring protocol has been implemented since 2006 in 11 northeastern national parks in partnership with the <a href="https://vtecostudies.org/">Vermont Center of Ecostudies</a> and many volunteer birders. 

<p>This report summarizes park-level results from a recent trend analysis (Doser et al. 2020) which addressed the following  monitoring objectives:</p>
<ul>
 <li> Determine long-term trends in species composition of breeding landbirds in the park. </li> 
 <li> Determine changes in relative abundance of commonly detected and <a href="http://pif.birdconservancy.org/"> Partners in Flight Priority </a> species at each park, as determined by Bird Conservation Regions.</li> </ul>
  
<h3>Methods</h3>

<p>The analysis in this report is based on repeated visits to the permanent monitoring sites shown in the map. Each point is typically visited once or twice a year, during the late spring to mid-summer. At each visit all birds heard or seen during a 10-minute period are recorded. Additionally, the observers indicate an approximate distance to the bird, for example, between 50 to 100m meters away or further. For detailed information on the methods and analysis, please consult the monitoring protocol and associated references listed in the Citations tab. </p>

<p>If you have questions about this program, report, or would like to acquire data or speak about bird monitoring in your park please
contact NETN staff <a href="mailto:aaron_weed@nps.gov">Aaron Weed (Program Manager)</a>, <a href="mailto:ed_sharron@nps.gov">Ed Sharron (Bird Volunteer Coordinator)</a>, or <a href="mailto:adam_kozlowksi@nps.gov"> Adam Kozlowski (Data Manager)</a>.</p>

### Bird Diversity {.tabset}

#### No. of Species over time

```{r richness, echo = TRUE, echo=FALSE, fig.height=6, fig.width= 10, fig.align = 'center'}

plotdata<- dplyr::filter(ParkCommAnnual, park == Park) %>% select(Year= year, `Estimated Richness` = median.rich, low = low.95.rich, hi = high.95.rich) %>% 
  left_join(., NCRNbirds::birdRichness(network[ParkList == Park], band= 1:2, byYear = TRUE), by = "Year") %>% rename(`Observed Richness` = Richness) 

colors<- c("Field Observation" = "#2171b5","Estimated (95% C.I.)"= "dark green")
 
GraphOut<-ggplot(data=plotdata, aes(x = Year))+expand_limits(y=0)+
      geom_ribbon(data= plotdata, aes(ymin= low, ymax= hi), fill= "grey95", outline.type = "both")+
      geom_point(aes(y= `Estimated Richness`, color = "Estimated (95% C.I.)"),  size=2)+geom_line(aes(y= `Estimated Richness`, color = "Estimated (95% C.I.)"))+
      geom_point(aes(y= `Observed Richness`, color= "Field Observation"), size=2) + geom_line(aes(y= `Observed Richness`, color= "Field Observation"))+
      theme_classic()+  
      theme(axis.title.y =element_text(size = 14, face ="bold", vjust= 1))+
      theme(axis.title.x =element_text(size = 14, face ="bold", vjust= 1))+
      theme(axis.text.y = element_text(color="black", vjust= 0.5,size = 12))+
      theme(axis.text.x = element_text(color="black", size = 12))+
      scale_color_manual(values = colors)+
      scale_x_continuous(breaks = seq(2006, 2019,1))+
      labs(y=" Number of Species" ,x= "", color = "")+theme(legend.position = c(0.8,0.2))+ theme(legend.text = element_text(size = 14))

GraphOut

```

<h4> This graph shows the number of bird species observed during monitoring each year (blue) and the number of species estimated after accounting for imperfect detection (green, see Doser et al. 2020). Note that this plot is not showing  the total number of bird species in the park, as other species may be present but not detected during monitoring. Data are summarized among all annual visits to a site and include all species detected within 100 meters of each observer.</h4>

#### No. of Species among sites

<div style="float:right;position:relative;top:10px;padding:5px 5px 5px 10px;margin:0px 5px 10px 5px">
```{r richmap, echo = FALSE,  fig.height=6, fig.width= 6, fig.align = 'left', warning= FALSE, comment=FALSE, message=FALSE, fig.cap= "Map of Species Richness at permanent sites"}
mapRichness(network[ParkList == Park], title = "No. of species", palette = "viridis", band = 1:2)
```
</div>

<h4> This map shows the cumulative total number of species observed during field surveys per site since `r minYear`. Clicking on the site displays the unique site name and observed species richness.</h4>

### Bird Community Index {.tabset}

#### Over time
<h3>Bird Community Index </h3>

<p>The Bird Community Index (BCI- O'Connell et al 1998, 2000) is an index designed to indicate the conservation status of the bird community in
forested areas such as those in NETN parks. To calculate this, the list of birds from each site is considered separately. If a site has many bird
species that are typically restricted to intact forest areas (&quot;forest obligates&quot;) the site gets a high score, whereas birds that live in a
variety of areas (&quot;generalists&quot;) give a site a low score.</p>

<div style="float:right;position:relative;top:10px;padding:1px 1px 1px 1px;margin:0px 5px 10px 5px">
```{r BCI, echo=FALSE, fig.height=4, fig.width= 8, fig.align = 'center', message=FALSE}
NCRNbirds::BCIPlot(network[ParkList == Park], type= "Cent_Appal",  plot_title = "Average annual Bird Community Index across park", band = 1:2, caption = FALSE)
```
Data above are summarized from field observations within 100 meters of the observer. The points on the graph denote the BCI rating for points monitored during 2019. The horizontal axis indicates the year, with the number of points monitored by visit in parenthesis. 
</div>

<p>Many factors are used to assess the
degree to which a bird species is a generalist or a forest obligate. These
include: </p>
<p>
<ul>
 <li>What habitat does the species prefer?</li>
 <li>Is the species restricted to the interior of forests?</li>
 <li>Where does the species nest (trees, shrubs, ground, etc)?</li>
 <li>What does the species eat (insects in bark, insect on the ground, omnivore,etc) </li>
 <li>Does the species a predator or parasite of other bird's nests?</li>
 <li>Is it an exotic species?</li>
 <li>Is the species resident year round or does it migrate?</li>
 <li>How many broods does the species raise per year?</li>
</ul>
</p>
<p>Based on these assessments each point is assigned a score. The scores are then averaged for the entire park.
This average score is used to categorize the bird community of the park as either Low, Medium, High or Highest Integrity. </p>

#### BCI across park
<h4> Bird Community Index ratings for permanent monitoring sites in `r year`. </h4>

```{r map, echo = TRUE, echo=FALSE, fig.height=6, fig.width= 10, fig.align = 'center', message=FALSE}
mapBCI(network[ParkList == Park], band =2, type= "Cent_Appal", years = 2019)
```

Data in the map are summarized from field observations within 100 meters of the observer. The points on the map denote the BCI rating for sites monitored during `r year`. Clicking on the site displays the unique site name and the BCI rating.

### Species trends {.tabset}
#### Relative Abundance

<h4> Average number of birds per site of the 20 most commonly detected species in `r Park` </h4>. 

```{r top20,echo=FALSE,results='hide',fig.keep='all', cache= TRUE,  fig.height=6, fig.width= 8, fig.align = 'center', message=FALSE,warning = FALSE, comment=NA}

aou<-SumRelAbund(network[ParkList == Park], max=T, sort=TRUE, abund = 20, band = 1:2)$AOU_Code # get Top 20 most abundant species (birds/point)
  
spp<-getBirdNames(network[ParkList == Park], names= aou , out.style = "common") %>% 
    bind_cols(.,aou ) %>% tibble() %>% rename(common = 1, AOU_Code =2)
      
plotdata<-SumRelAbund(network[ParkList == Park], max=T, AOU = aou, band = 1:2, CalcByYear =FALSE ) %>% 
  group_by(AOU_Code) %>% 
  summarise(mean = round(mean(RelAbund,na.rm=T),2), se = sd(RelAbund)/sqrt(n()), n= n()) %>% 
  left_join(spp,., by = "AOU_Code")

BarChart<-ggplot(data= plotdata, aes(x=reorder(common,mean), y = mean)) +
geom_bar(fill="#2171b5", stat="identity",width=0.75) +
#geom_errorbar(aes(ymin= mean-se, ymax= mean +se), width = .2, color = "#2171b5")+
coord_flip()+
geom_text(aes(label = sprintf("%0.2f", round(mean, digits = 2))), hjust = -0.15, color = "black", size = 4)+
scale_y_continuous(expand = c(0,0),limits = c(0, max(plotdata$mean*1.1)))+ #set origin at 0, sets width of x axis
xlab("") +
ylab("Average number of birds detected per point per visit")+ 
theme_classic()+
theme(axis.text.y = element_text(color="black",size = 12))+
theme(axis.text.x = element_text(color="black",size = 12))+
theme(axis.title.x = element_text(color="black",size = 12, face= "bold"))

BarChart
```

Data are summarized within 100 meters from the observer and from the maximum number of birds detected among visits in a year.  The horizontal axis indicates the number of birds detected divided by the number of points monitored.

#### Trends over time

<div style="float:right;position:relative;top:10px;padding:5px 5px 5px 10px;margin:0px 5px 10px 5px">
```{r top10trend,echo=FALSE,results='hide',fig.keep='all', cache= TRUE,  fig.height=4, fig.width= 6, fig.align = 'right', message=FALSE,warning = FALSE, comment=NA}

aou<-SumRelAbund(network[ParkList == Park], max=T, sort=TRUE, abund = 10, band = 1:2)$AOU_Code # get Top 20 most abundant species (birds/point)
  
spp<-getBirdNames(network[ParkList == Park], names= aou , out.style = "common") %>% 
    bind_cols(.,aou ) %>% tibble() %>% rename(common = 1, AOU_Code =2)%>% 
    mutate(order= row_number())
      
plotdata<-filter(spMeanYearEffect, AOU_Code %in% aou) %>% 
   left_join(spp,., by = "AOU_Code") %>% 
    mutate(common = fct_reorder(common, order)) %>% 
    mutate(common = paste0(common, " (", order,")"))

BarChart<-ggplot(data= plotdata, aes(x=reorder(common,mean), y = mean)) +
geom_bar(fill="#2171b5", stat="identity",width=0.75) +
geom_errorbar(aes(ymin=lowCI, ymax= highCI), width = .2, color = "black")+
coord_flip()+ 
#geom_text(aes(label = sprintf("%0.2f", round(mean, digits = 2))), y = plotdata$mean, hjust= 1, vjust= 1,color = "black", size = 4)+
#scale_y_continuous(expand = c(0,0),limits = c(0, max(plotdata$mean*1.1)))+ #set origin at 0, sets width of x axis
xlab("") +
ylab(paste("Estimated trend over time : Birds per point per year", "\u00B1", " 95% C.I."))+ 
theme_classic()+
theme(axis.text.y = element_text(color="black",size = 12))+
theme(axis.text.x = element_text(color="black",size = 12))+
theme(axis.title.x = element_text(color="black",size = 12, face= "bold"))+
  geom_hline(yintercept= 0, col= 1)+
  theme(panel.grid.major.x = element_line(color="grey",linetype = "dashed"))+
      theme(panel.grid.major.y = element_line(color="grey", linetype = "dashed"))

BarChart
```
</div>

To the right are the plotted trend estimates for top 10 most abundant species in the park from Doser et al. (2020). Populations in the park are stable when the trend estimate error bars, or credible intervals (C.I.), do not overlap 0 (e.g. Eastern Wood-Pewee). The rank order of abundance in the park is denoted in parentheses following the species name. None of the most abundant species are increasing over time in the park but 6 of 10 species have stable populations. Scarlet Tanager, American Robin, Blue Jay, and Tufted Titmouse detections declined significantly during the monitoring period from `r minYear ` - `r maxYear `.

#### Species plots

Here are the average annuals counts and associated trends of the top 10 most abundant species detected since `r min(getBirds(network[ParkList == Park])$Year)` across the park over time and showing the trend. Plots show the average annual abundance of bird observations within 100 meters of the observer among sites. During years when a site was surveyed more than once, the plotted average is calculated from the maximum count per survey visit in a year. The estimate of the trend (95% C.I.) is denoted in the upper right of each panel. If the interval does  not contain 0 the trend is statistically decreasing over time (e.g., Tufted Titmouse).

<div style="float:right;position:relative;top:10px;padding:5px 5px 5px 10px;margin:0px 5px 10px 5px">
```{r Top10TrendPlots,echo=FALSE,results='hide',fig.keep='all', fig.height=16, fig.width= 10, fig.align = 'center', message=FALSE,warning = FALSE, comment=NA}

#Get Top 10 species
aou<-SumRelAbund(network[ParkList == Park], max=T, sort=TRUE, abund = 10, band = 1:2)$AOU_Code

spp<-getBirdNames(network[ParkList == Park], names= aou , out.style = "common") %>% 
    bind_cols(.,aou ) %>% tibble() %>% rename(common = 1, AOU_Code =2) %>% 
    mutate(order= row_number())

#subset sp_detects    

plotdata<-filter(sp_detects, AOU_Code %in% aou) %>% 
   left_join(spp,., by = "AOU_Code") %>% 
    mutate(common = paste0(common, " (", order,")")) %>% 
    mutate(common = fct_reorder(common, order)) %>% 
  left_join(., spMeanYearEffect, by=c("AOU_Code", "park")) %>% 
   group_by(common, variable) %>%
    mutate(sig= between(0,lowCI,highCI))# determine in CI contains 0; returns TRUE

GraphOut<-ggplot(data=plotdata, aes(x = Year, y = value, color = variable))+expand_limits(y=0)+
      geom_point(data= dplyr::filter(plotdata, variable == "Field Observation"),size=2) + geom_line(data = filter(plotdata,sig == FALSE | variable == "Field Observation"))+
      #geom_errorbar(aes(ymin= mean-se, ymax= mean +se), width = .2, color = "#2171b5")+
      theme_classic()+
      theme(axis.title.y =element_text(size = 14, face ="bold", vjust= 1))+
      theme(axis.title.x =element_text(size = 14, face ="bold", vjust= 1))+
      theme(axis.text.y = element_text(color="black", vjust= 0.5,size = 12))+
      theme(axis.text.x = element_text(color="black", size = 10))+
      scale_x_continuous(breaks = seq(2006, 2019,2))+
      scale_color_manual(values = c("#2171b5", "dark green"))+
      labs(y="Number detected per point" , color = "")+
      theme(legend.position = "top")+ 
      theme(legend.text = element_text(size = 12))+
       theme(panel.background =  element_rect(fill="white", colour="black")) +
       theme(plot.title=element_text(size=12, vjust=2, face= "bold")) +
       theme(strip.background= element_rect(size=10, color="gray", linetype ="solid" ))+
      theme(strip.text=element_text(size=12, vjust=0, face= "bold"))+
      facet_wrap(~common, ncol = 2, shrink= FALSE)

GraphOut+
  geom_text(data= dplyr::filter(plotdata, variable == "Trend Estimate")  %>% distinct(common, park, variable, mean, lowCI, highCI), show.legend = FALSE, aes(x = Inf, y = Inf, label = paste(round(mean,2)," (",round(lowCI,2),",",round(highCI,2),")"), hjust = 1.05,vjust   = 1))

```
</div>

### Supporting Resources

```{r, results='asis', echo=F}
cat(readLines('Citations.html'))
```